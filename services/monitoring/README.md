# Сервис мониторинга для микросервисной архитектуры

Этот сервис предназначен для мониторинга работоспособности всех микросервисов проекта Telegram Mini App Audio Recorder. Он обеспечивает постоянный контроль состояния системы и оперативное уведомление о проблемах.

## Основные возможности

- Проверка доступности и функциональности всех микросервисов каждую минуту
- Анализ времени отклика сервисов и фиксация аномалий
- Отслеживание времени непрерывной работы и восстановления после сбоев
- Отправка минутных отчетов о состоянии системы в Telegram
- Мгновенное оповещение о недоступности сервисов в Telegram
- Веб-интерфейс для просмотра текущего состояния системы
- Сохранение истории состояний для последующего анализа
- Мониторинг системных ресурсов (память, CPU, время работы)

## Запуск сервиса

### Требования

- Node.js 14+
- Токен бота Telegram
- ID группы или чата Telegram для отправки уведомлений

### Переменные окружения

Создайте файл `.env` в директории сервиса мониторинга со следующими переменными:

```
# Настройки сервера
PORT=3006

# Настройки Telegram
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=ид_группы_или_чата

# Пути к микросервисам (опционально)
DATA_STORAGE_URL=http://localhost:3002
AUDIO_PROCESSOR_URL=http://localhost:3003
DOCUMENTATION_URL=http://localhost:3004
API_CORE_URL=http://localhost:3001
TELEGRAM_APP_URL=http://localhost:3000
ADMIN_PANEL_URL=http://localhost:3005

# Настройки мониторинга
HEALTH_CHECK_INTERVAL=60000  # Интервал проверки в миллисекундах
```

### Скрипты для управления

В директории сервиса есть готовые скрипты для управления:

- `start-monitoring.sh` - запускает сервис мониторинга в фоновом режиме
- `stop-monitoring.sh` - останавливает сервис мониторинга
- `view-logs.sh` - показывает текущие логи и статус сервиса

### Запуск сервиса вручную

```bash
# Установка зависимостей (если еще не установлены)
npm install

# Запуск сервиса
node src/index.js
```

## Структура директорий

- `src/` - исходный код основного приложения
- `utils/` - вспомогательные модули (telegram, health-check, logger и т.д.)
- `public/` - файлы веб-интерфейса
- `logs/` - директория для логов работы сервиса
- `status_logs/` - директория для сохранения истории состояний

## API сервиса

Сервис предоставляет следующие API:

- `GET /health` - проверка работоспособности самого сервиса мониторинга
- `GET /api/status` - получение текущего статуса всех микросервисов
- `GET /api/logs` - получение результатов анализа логов
- `POST /api/send-report` - принудительная отправка отчета в Telegram

## Интерпретация отчетов Telegram

Сервис отправляет в Telegram отчеты следующих типов:

1. **Регулярные отчеты** - отправляются каждую минуту, содержат:
   - Время генерации отчета
   - Информацию о системе (uptime, память, CPU)
   - Статус каждого микросервиса (активен/недоступен)
   - Время отклика каждого микросервиса
   - Информацию о восстановлении после сбоев

2. **Уведомления о сбоях** - отправляются при обнаружении недоступности сервиса:
   - Список недоступных сервисов

3. **Уведомления о восстановлении** - отправляются при восстановлении сервиса после сбоя:
   - Имя восстановленного сервиса
   - Время простоя сервиса

## Устранение неполадок

### Сервис не запускается

1. Проверьте наличие всех необходимых переменных окружения
2. Убедитесь, что порт 3006 не занят другим приложением
3. Проверьте логи ошибок в директории `logs/`

### Не отправляются уведомления в Telegram

1. Проверьте правильность токена бота и ID чата
2. Убедитесь, что бот имеет права на отправку сообщений в указанный чат
3. Проверьте доступность API Telegram

### Неверный статус сервисов

1. Проверьте корректность URL микросервисов в переменных окружения
2. Убедитесь, что сервисы имеют доступный эндпоинт для проверки здоровья