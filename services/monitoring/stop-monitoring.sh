#!/bin/bash

# Скрипт для остановки сервиса мониторинга

# Путь к директории мониторинга
MONITORING_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PID_FILE="${MONITORING_DIR}/monitoring.pid"

# Проверка существования PID файла
if [ ! -f "$PID_FILE" ]; then
  echo "Ошибка: PID файл не найден. Сервис мониторинга не запущен или был остановлен некорректно."
  exit 1
fi

# Чтение PID из файла
PID=$(cat "$PID_FILE")

# Проверка существования процесса
if ! ps -p $PID > /dev/null; then
  echo "Предупреждение: Процесс с PID $PID не найден. Возможно, сервис уже остановлен."
  rm -f "$PID_FILE"
  exit 0
fi

# Остановка процесса
echo "Остановка сервиса мониторинга (PID: $PID)..."
kill $PID

# Ожидание завершения процесса
for i in {1..5}; do
  if ! ps -p $PID > /dev/null; then
    echo "Сервис мониторинга успешно остановлен."
    rm -f "$PID_FILE"
    exit 0
  fi
  sleep 1
done

# Если процесс не остановился, принудительно завершаем
echo "Сервис мониторинга не остановился. Принудительное завершение..."
kill -9 $PID
rm -f "$PID_FILE"
echo "Сервис мониторинга принудительно остановлен."
exit 0