# Микросервисная архитектура проекта

## Обзор микросервисов

Проект построен на микросервисной архитектуре, где каждый сервис отвечает за выполнение конкретной функции. Такой подход обеспечивает лучшую масштабируемость, независимую разработку и развертывание, а также изоляцию ошибок.

## Текущие микросервисы

### 1. API-сервис (services/api-core)
- **Основное назначение**: Центральный API для обработки запросов от клиентов
- **Ключевые файлы**: 
  - `services/api-core/src/index.ts` - входная точка сервиса
  - `services/api-core/src/routes/index.ts` - маршруты API
- **Функциональность**:
  - Обработка HTTP-запросов
  - Маршрутизация к другим микросервисам
  - Валидация данных
  - Аутентификация и авторизация

### 2. Сервис хранения данных (services/data-storage)
- **Основное назначение**: Управление хранением данных приложения
- **Ключевые файлы**:
  - `services/data-storage/models/schema.ts` - схемы данных
  - `services/data-storage/repositories/storage-interface.ts` - интерфейс хранилища
  - `services/data-storage/repositories/memory-storage.ts` - реализация хранилища в памяти
- **Функциональность**:
  - Управление моделями данных
  - CRUD-операции с данными
  - Абстракция базы данных

### 3. Сервис обработки аудио (services/audio-processor)
- **Основное назначение**: Обработка аудиофайлов и транскрипция
- **Ключевые файлы**:
  - `services/audio-processor/src/index.ts` - входная точка сервиса
  - `services/audio-processor/utils/ffmpeg.ts` - утилиты для работы с аудио через FFmpeg
  - `services/audio-processor/utils/audio.ts` - функции обработки аудио
  - `services/audio-processor/utils/openai.ts` - интеграция с OpenAI для транскрипции
- **Функциональность**:
  - Объединение фрагментов аудио
  - Конвертация аудиоформатов
  - Транскрипция аудио через OpenAI API
  - Оптимизация аудио для распознавания речи

### 4. Сервис мониторинга (services/monitoring)
- **Основное назначение**: Отслеживание работоспособности всех сервисов
- **Ключевые файлы**:
  - `services/monitoring/src/index.js` - основной файл сервиса
  - `services/monitoring/utils/health-check.js` - проверка здоровья сервисов
  - `services/monitoring/utils/telegram.js` - отправка уведомлений через Telegram
  - `services/monitoring/utils/logger.js` - логирование событий
  - `services/monitoring/utils/log-analyzer.js` - анализ логов
- **Функциональность**:
  - Регулярные проверки здоровья всех сервисов
  - Отправка уведомлений при проблемах
  - Ведение истории статусов
  - Веб-интерфейс для просмотра статусов

### 5. Сервис аудио-оповещений (services/audio-notifier)
- **Основное назначение**: Отправка аудиозаписей и транскрипций в Telegram
- **Ключевые файлы**:
  - `services/audio-notifier/src/index.js` - основной файл сервиса
  - `services/audio-notifier/utils/telegram.js` - утилиты для работы с Telegram API
  - `services/audio-notifier/utils/logger.js` - логирование
  - `services/audio-notifier/utils/helpers.js` - вспомогательные функции
- **Функциональность**:
  - Проверка наличия новых аудиозаписей
  - Скачивание аудиофайлов из основного сервиса
  - Отправка аудио и транскрипций в Telegram
  - Отслеживание статуса отправки

### 6. Документационный сервис (services/documentation)
- **Основное назначение**: Предоставление документации API и файлов
- **Ключевые файлы**:
  - `services/documentation/src/index.ts` - сервер документации
- **Функциональность**:
  - Доступ к документации API
  - Предоставление файлов Markdown
  - Статические файлы

### 7. Панель администратора (services/admin-panel)
- **Основное назначение**: Веб-интерфейс для управления системой
- **Ключевые файлы**:
  - `services/admin-panel/package.json` - зависимости
- **Функциональность**:
  - Управление записями
  - Мониторинг системы
  - Управление пользователями

### 8. Telegram мини-приложение (services/telegram-app)
- **Основное назначение**: Клиентское приложение для Telegram
- **Ключевые файлы**:
  - `services/telegram-app/package.json` - зависимости
- **Функциональность**:
  - Интерфейс для записи аудио
  - Отправка аудиофрагментов
  - Просмотр транскрипций

## Скрипты управления микросервисами

- `services/start-all.sh` - запуск всех сервисов
- `services/stop-all.sh` - остановка всех сервисов
- `services/start-monitoring.sh` - запуск сервиса мониторинга
- `services/stop-monitoring.sh` - остановка сервиса мониторинга
- `services/replit-monitor.js` - улучшенный мониторинг для Replit

## Заархивированные компоненты

Некоторые компоненты были заархивированы для улучшения структуры проекта:

- **Интеграция с Zepp OS** - заархивирована в `archived/zepp_integration.tar.gz`
  - Ранее включала пакет приложения для умных часов и соответствующую документацию
  - Подробная информация доступна в `archived/README.md`

## Диаграмма взаимодействия микросервисов

```
+----------------+     +----------------+     +----------------+
| Telegram App   |---->|   API Core     |---->| Data Storage   |
+----------------+     +----------------+     +----------------+
        |                     |                      |
        v                     v                      v
+----------------+     +----------------+     +----------------+
| Admin Panel    |<--->| Audio Processor|---->| Monitoring     |
+----------------+     +----------------+     +----------------+
        |                     |                      |
        v                     v                      v
+----------------+     +----------------+     +----------------+
| Documentation  |     | Audio Notifier |---->| Telegram API   |
+----------------+     +----------------+     +----------------+
```

## Особенности архитектуры

1. **Коммуникация**: Сервисы взаимодействуют через HTTP API.
2. **Логирование**: Каждый сервис имеет свою систему логирования.
3. **Конфигурация**: Сервисы используют .env файлы для конфигурации.
4. **Управление**: Каждый сервис может быть запущен и остановлен независимо.
5. **Масштабирование**: Архитектура позволяет независимо масштабировать отдельные компоненты.

## Replit-специфичные особенности

Из-за ограничений платформы Replit:
- Docker не используется для контейнеризации
- Фоновые процессы запускаются напрямую
- Для мониторинга разработаны специальные скрипты
- Все сервисы работают в одном окружении

## Техническая задолженность и потенциальные улучшения

1. Добавление автоматического восстановления сервисов после падения
2. Улучшение системы логирования с централизованным сбором логов
3. Внедрение более надежной системы управления состоянием сервисов
4. Оптимизация механизма мониторинга для работы в Replit
5. Улучшение документации микросервисов