# Мониторинг API - Документация

## Обзор

Система мониторинга представляет собой набор инструментов для отслеживания состояния основного сервиса, автоматического восстановления при сбоях и уведомления о проблемах через Telegram.

## Компоненты

Система мониторинга состоит из следующих основных компонентов:

1. **Встроенный мониторинг**: Выполняется непосредственно в основном сервисе, выводит статус в консоль.
2. **Внешний мониторинг**: Отдельные сервисы, которые контролируют основной сервис и могут перезапустить его при необходимости:
   - `simple-monitor.mjs` - Базовая версия мониторинга
   - `enhanced-monitor.mjs` - Расширенная версия с улучшенной отказоустойчивостью и системными метриками

## API Конечные точки

### Проверка состояния сервера (Health Check)

```
GET /health
```

**Параметры запроса**: Нет

**Ответ**:
```json
{
  "status": "ok",
  "uptime": 3600,
  "memory": {
    "heapUsed": "50MB",
    "heapTotal": "100MB"
  },
  "timestamp": "2025-04-07T12:00:00.000Z"
}
```

**Коды состояния**:
- `200 OK`: Сервис работает нормально
- `500 Internal Server Error`: Сервис недоступен или имеет проблемы

### Дополнительная информация о системе

```
GET /system-info
```

**Параметры запроса**: Нет

**Ответ**:
```json
{
  "status": "ok",
  "cpu": {
    "usage": "25.5%",
    "loadAvg": [1.2, 1.4, 1.5]
  },
  "memory": {
    "total": "4GB",
    "free": "2GB",
    "usage": "50%"
  },
  "disk": {
    "total": "50GB",
    "free": "30GB",
    "usage": "40%"
  },
  "uptime": {
    "system": 86400,
    "service": 3600
  },
  "timestamp": "2025-04-07T12:00:00.000Z"
}
```

## Управление мониторингом

### Скрипты управления

1. **Запуск мониторинга**:
   - `node start-enhanced-monitoring.js` - Запуск расширенного мониторинга
   - `node start-monitoring-service.js` - Запуск стандартного мониторинга

2. **Остановка мониторинга**:
   - `node stop-enhanced-monitoring.js` - Остановка расширенного мониторинга
   - `node stop-monitoring-service.js` - Остановка стандартного мониторинга

3. **Проверка состояния**:
   - `node check-monitoring-status.js` - Проверка состояния мониторинга и сервиса

### Параметры конфигурации

Система мониторинга использует следующие параметры конфигурации:

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `checkInterval` | Интервал проверки работоспособности сервиса (мс) | 30000 (30 секунд) |
| `alertThreshold` | Количество последовательных ошибок перед оповещением | 3 |
| `restartInterval` | Минимальный интервал между перезапусками (мс) | 120000 (2 минуты) |
| `maxRestarts` | Максимальное количество автоматических перезапусков | 3 |
| `telegramReportInterval` | Интервал отправки отчетов в Telegram | `0 */5 * * * *` (каждые 5 минут) |
| `telegramRetryCount` | Количество попыток отправки в Telegram | 3 |
| `telegramRetryDelay` | Задержка между попытками отправки (мс) | 5000 (5 секунд) |

## Telegram-уведомления

Система использует Telegram API для отправки уведомлений о состоянии сервиса.

### Необходимые переменные окружения

1. `TELEGRAM_BOT_TOKEN` - Токен бота Telegram для отправки уведомлений
2. `TELEGRAM_CHAT_ID` - ID чата/группы/канала для отправки уведомлений

### Типы уведомлений

1. **Регулярные статусные отчеты**:
   - Отправляются каждые 5 минут
   - Содержат информацию о времени отклика, аптайме, использовании памяти и т.д.

2. **Уведомления о сбоях**:
   - Отправляются при обнаружении проблем с сервисом
   - Содержат информацию о причине ошибки и планируемых действиях

3. **Уведомления о восстановлении**:
   - Отправляются после восстановления работы сервиса
   - Содержат информацию о времени простоя и количестве перезапусков

## Логирование

Система мониторинга ведет подробное логирование своей работы:

- **Файл логов**: `enhanced-monitoring.log`
- **Структура логов**: `[Временная метка] [Уровень логирования] Сообщение`

## Рекомендации по использованию

1. **Запуск мониторинга**:
   - Рекомендуется использовать расширенную версию `enhanced-monitor.mjs` для большинства случаев
   - Перед запуском убедитесь, что настроены переменные окружения для Telegram

2. **Настройка Telegram**:
   - Создайте бота через @BotFather и получите токен
   - Определите ID чата, добавив бота в нужный чат и выполнив скрипт `get_telegram_group_id.js`

3. **Проверка работоспособности**:
   - Регулярно проверяйте статус мониторинга с помощью `check-monitoring-status.js`
   - Убедитесь, что уведомления в Telegram приходят корректно

## Примеры использования

### Пример 1: Запуск расширенного мониторинга

```bash
# Установка переменных окружения (или добавьте в .env файл)
export TELEGRAM_BOT_TOKEN=<ваш_токен>
export TELEGRAM_CHAT_ID=<ваш_chat_id>

# Запуск мониторинга
node start-enhanced-monitoring.js
```

### Пример 2: Проверка состояния

```bash
# Подробный отчет о состоянии мониторинга
node check-monitoring-status.js
```

### Пример 3: Остановка мониторинга

```bash
# Корректное завершение процесса мониторинга
node stop-enhanced-monitoring.js
```

## Устранение неполадок

1. **Мониторинг не запускается**:
   - Проверьте наличие всех зависимостей: `npm list axios node-telegram-bot-api cron`
   - Убедитесь, что нет остатков предыдущего процесса: `ps aux | grep monitor`

2. **Уведомления не отправляются**:
   - Проверьте правильность токена бота и chat ID
   - Убедитесь, что бот имеет права на отправку сообщений в чат/группу

3. **Перезапуск сервера не работает**:
   - Проверьте, правильно ли указана команда в `CONFIG.restartCommand`
   - Убедитесь, что скрипт имеет необходимые права для запуска процессов
