# Микросервисная архитектура для Telegram Mini App Audio Recorder

Проект разделен на независимые микросервисы для обеспечения высокой устойчивости, масштабируемости и поддержки Zepp OS 3.0.

## Структура микросервисов

### 1. Telegram Mini App (Frontend)
- **Директория**: `services/telegram-app`
- **Порт**: 3000
- **Описание**: Клиентское приложение для записи аудио, работающее в Telegram.
- **Основные функции**:
  - Интерфейс пользователя для записи аудио
  - Отправка фрагментов аудио на сервер
  - Интеграция с Telegram Mini App SDK

### 2. Админ-панель (Frontend)
- **Директория**: `services/admin-panel`
- **Порт**: 3005
- **Описание**: Административный интерфейс для управления записями.
- **Основные функции**:
  - Просмотр и управление всеми записями
  - Фильтрация и поиск записей
  - Отправка записей пользователям
  - Аналитика и статистика

### 3. API Core (Backend)
- **Директория**: `services/api-core`
- **Порт**: 3001
- **Описание**: Основной API сервис, маршрутизирующий запросы к другим микросервисам.
- **Основные функции**:
  - Обработка HTTP запросов
  - Маршрутизация запросов к нужным микросервисам
  - Аутентификация и авторизация
  - Управление сессиями

### 4. Сервис Обработки Аудио
- **Директория**: `services/audio-processor`
- **Порт**: 3003
- **Описание**: Сервис для обработки аудио файлов.
- **Основные функции**:
  - Объединение фрагментов аудио
  - Транскрипция аудио через OpenAI
  - Оптимизация аудио для лучшего качества транскрипции
  - Анализ и обработка аудио

### 5. Сервис Документации
- **Директория**: `services/documentation`
- **Порт**: 3004
- **Описание**: Сервис для предоставления документации и файлов через API.
- **Основные функции**:
  - Предоставление HTML документации
  - Конвертация Markdown в HTML
  - Доступ к файлам для скачивания
  - Списки доступных файлов

### 6. Сервис Хранения Данных
- **Директория**: `services/data-storage`
- **Порт**: 3002
- **Описание**: Сервис для управления данными и доступа к базе данных.
- **Основные функции**:
  - CRUD операции для записей
  - Работа с фрагментами записей
  - Управление связями между данными
  - Абстракция доступа к базе данных

### 7. Сервис Мониторинга
- **Директория**: `services/monitoring`
- **Порт**: 3006
- **Описание**: Сервис для мониторинга работоспособности всех микросервисов.
- **Основные функции**:
  - Проверка состояния всех микросервисов каждую минуту
  - Сбор и анализ логов работы системы
  - Отправка минутных отчетов в Telegram-группу
  - Оповещение об ошибках и сбоях в работе
  - Сбор метрик производительности (память, CPU, время работы)
  - Отслеживание времени восстановления сервисов
  - Веб-интерфейс для просмотра статуса системы

## Запуск микросервисов

Для запуска всех микросервисов используйте:

```bash
# В корневой директории проекта
npm run start:all
```

Или запустите каждый сервис отдельно:

```bash
# Сервис хранения данных
cd services/data-storage
npm run dev

# Сервис обработки аудио
cd services/audio-processor
npm run dev

# API Core сервис
cd services/api-core
npm run dev

# Сервис документации
cd services/documentation
npm run dev

# Telegram Mini App и Админ-панель
cd services/telegram-app
npm run dev

cd services/admin-panel
npm run dev

# Сервис мониторинга
cd services/monitoring
./start-monitoring.sh
```

### Управление сервисом мониторинга

Сервис мониторинга имеет удобные скрипты для управления:

```bash
# Запуск сервиса мониторинга
cd services/monitoring
./start-monitoring.sh

# Остановка сервиса мониторинга
cd services/monitoring
./stop-monitoring.sh

# Просмотр логов и статуса сервиса мониторинга
cd services/monitoring
./view-logs.sh
```

Сервис мониторинга доступен по адресу `http://localhost:3006` и предоставляет веб-интерфейс для просмотра статуса всех сервисов.

#### Настройка Telegram-оповещений

Для работы Telegram-оповещений необходимы следующие переменные окружения:

```
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=идентификатор_группы_или_чата
```

Токен можно получить у [@BotFather](https://t.me/BotFather), а идентификатор чата можно узнать с помощью скрипта `get_telegram_group_id.js`.

## Коммуникация между сервисами

Микросервисы взаимодействуют через REST API. Каждый сервис имеет свой порт и предоставляет API для других сервисов.

Типичный поток обработки запроса:
1. Клиент (Telegram Mini App или Админ-панель) отправляет запрос на API Core
2. API Core проверяет аутентификацию и маршрутизирует запрос
3. Запрос обрабатывается соответствующим микросервисом
4. Результат возвращается через API Core клиенту

## Особенности интеграции с Zepp OS 3.0

- Zepp устройства отправляют аудио-фрагменты на API Core через специальные эндпоинты
- Фрагменты обрабатываются так же, как и фрагменты от Telegram Mini App
- Добавлены специальные флаги для отслеживания источника записи (zepp: true)
- Документация и пакеты Zepp доступны через сервис документации

## Отказоустойчивость

Преимущества микросервисной архитектуры:
- Изолированные сбои не влияют на всю систему
- Возможность горизонтального масштабирования отдельных сервисов
- Упрощенное обновление и развертывание отдельных компонентов
- Возможность независимой разработки и тестирования