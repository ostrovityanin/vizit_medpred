#!/bin/bash

# Скрипт для остановки GPT-4o Audio Preview микросервиса

# Переходим в директорию микросервиса
cd "$(dirname "$0")"

# Проверяем наличие файла с PID
if [ -f .pid ]; then
  PID=$(cat .pid)
  
  # Проверяем, запущен ли процесс
  if ps -p $PID > /dev/null; then
    echo "Останавливаем GPT-4o Audio Preview микросервис (PID: $PID)..."
    kill $PID
    
    # Даем немного времени на корректное завершение
    sleep 2
    
    # Проверяем, остановился ли процесс
    if ps -p $PID > /dev/null; then
      echo "Процесс не остановился. Принудительное завершение..."
      kill -9 $PID
    fi
    
    echo "Микросервис остановлен"
  else
    echo "Процесс с PID $PID не найден. Возможно, он уже остановлен."
  fi
  
  # Удаляем файл с PID
  rm .pid
else
  echo "Файл .pid не найден. Микросервис не запущен или был остановлен некорректно."
  
  # Пытаемся найти и остановить процесс по названию
  PID=$(ps aux | grep "[n]ode src/index.js" | awk '{print $2}')
  if [ ! -z "$PID" ]; then
    echo "Найден процесс микросервиса (PID: $PID). Останавливаем..."
    kill $PID
    echo "Микросервис остановлен"
  fi
fi